<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Running Progress Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <meta property="og:title" content="Running Progress Tracker">
  <meta property="og:description" content="Track your running progress in a beautiful, futuristic space-themed interface.">
  <meta property="og:image" content="https://picsum.photos/1200/630?random=1">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yourdomain.com/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Running Progress Tracker">
  <meta name="twitter:description" content="Track your running progress in a beautiful, futuristic space-themed interface.">
  <meta name="twitter:image" content="https://picsum.photos/1200/630?random=1">
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Orbitron', 'Segoe UI', sans-serif;
          background: linear-gradient(135deg, #010305 0%, #030712 50%, #050a14 100%);
          min-height: 100vh;
          padding: 20px;
          color: #e0e0e0;
          position: relative;
          overflow-x: hidden;
      }

      body::before {
          content: '';
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background:
                  radial-gradient(circle at 20% 80%, rgba(0, 180, 216, 0.03) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(0, 119, 182, 0.03) 0%, transparent 50%),
                  radial-gradient(circle at 50% 50%, rgba(0, 180, 216, 0.02) 0%, transparent 70%);
          z-index: -2;
          animation: backgroundPulse 20s ease-in-out infinite alternate;
      }

      @keyframes backgroundPulse {
          0% {
              opacity: 0.3;
              transform: scale(1);
          }
          50% {
              opacity: 0.5;
              transform: scale(1.05);
          }
          100% {
              opacity: 0.3;
              transform: scale(1);
          }
      }

      .stars {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: -1;
          pointer-events: none;
          perspective: 1000px;
          transform-style: preserve-3d;
      }

      .star {
          position: absolute;
          width: var(--size, 2px);
          height: var(--size, 2px);
          background: #fff;
          border-radius: 50%;
          animation: starTravel var(--duration) linear infinite;
          opacity: var(--opacity, 0.6);
      }

      @keyframes starTravel {
          0% {
              transform: translateZ(-100px);
              opacity: 0;
          }
          20% {
              opacity: var(--opacity, 0.6);
          }
          80% {
              opacity: var(--opacity, 0.6);
          }
          100% {
              transform: translateZ(200px);
              opacity: 0;
          }
      }

      .star:nth-child(1) { left: 7%; top: 23%; --duration: 22s; --opacity: 0.7; --size: 1.5px; }
      .star:nth-child(2) { left: 23%; top: 47%; --duration: 25s; --opacity: 0.6; --size: 2.8px; }
      .star:nth-child(3) { left: 37%; top: 82%; --duration: 28s; --opacity: 0.7; --size: 1.2px; }
      .star:nth-child(4) { left: 43%; top: 13%; --duration: 23s; --opacity: 0.6; --size: 2.5px; }
      .star:nth-child(5) { left: 52%; top: 34%; --duration: 27s; --opacity: 0.7; --size: 1.8px; }
      .star:nth-child(6) { left: 63%; top: 71%; --duration: 24s; --opacity: 0.6; --size: 2.2px; }
      .star:nth-child(7) { left: 74%; top: 42%; --duration: 26s; --opacity: 0.7; --size: 1.4px; }
      .star:nth-child(8) { left: 83%; top: 87%; --duration: 28s; --opacity: 0.6; --size: 2.7px; }
      .star:nth-child(9) { left: 92%; top: 58%; --duration: 25s; --opacity: 0.7; --size: 1.6px; }
      .star:nth-child(10) { left: 17%; top: 81%; --duration: 27s; --opacity: 0.6; --size: 2.3px; }
      .star:nth-child(11) { left: 28%; top: 19%; --duration: 23s; --opacity: 0.7; --size: 1.3px; }
      .star:nth-child(12) { left: 39%; top: 49%; --duration: 25s; --opacity: 0.6; --size: 2.6px; }
      .star:nth-child(13) { left: 47%; top: 73%; --duration: 28s; --opacity: 0.7; --size: 1.7px; }
      .star:nth-child(14) { left: 58%; top: 27%; --duration: 24s; --opacity: 0.6; --size: 2.4px; }
      .star:nth-child(15) { left: 67%; top: 59%; --duration: 26s; --opacity: 0.7; --size: 1.5px; }
      .star:nth-child(16) { left: 78%; top: 39%; --duration: 23s; --opacity: 0.6; --size: 2.8px; }
      .star:nth-child(17) { left: 87%; top: 63%; --duration: 27s; --opacity: 0.7; --size: 1.2px; }
      .star:nth-child(18) { left: 93%; top: 91%; --duration: 28s; --opacity: 0.6; --size: 2.5px; }
      .star:nth-child(19) { left: 6%; top: 7%; --duration: 25s; --opacity: 0.7; --size: 1.8px; }
      .star:nth-child(20) { left: 49%; top: 83%; --duration: 27s; --opacity: 0.6; --size: 2.2px; }
      .star:nth-child(21) { left: 57%; top: 17%; --duration: 23s; --opacity: 0.7; --size: 1.4px; }
      .star:nth-child(22) { left: 69%; top: 41%; --duration: 25s; --opacity: 0.6; --size: 2.7px; }
      .star:nth-child(23) { left: 77%; top: 79%; --duration: 28s; --opacity: 0.7; --size: 1.6px; }
      .star:nth-child(24) { left: 89%; top: 29%; --duration: 24s; --opacity: 0.6; --size: 2.3px; }
      .star:nth-child(25) { left: 96%; top: 51%; --duration: 26s; --opacity: 0.7; --size: 1.3px; }
      .star:nth-child(26) { left: 14%; top: 37%; --duration: 23s; --opacity: 0.6; --size: 2.6px; }
      .star:nth-child(27) { left: 31%; top: 64%; --duration: 26s; --opacity: 0.7; --size: 1.7px; }
      .star:nth-child(28) { left: 45%; top: 89%; --duration: 28s; --opacity: 0.6; --size: 2.4px; }
      .star:nth-child(29) { left: 61%; top: 21%; --duration: 25s; --opacity: 0.7; --size: 1.5px; }
      .star:nth-child(30) { left: 75%; top: 48%; --duration: 27s; --opacity: 0.6; --size: 2.8px; }
      .star:nth-child(31) { left: 91%; top: 76%; --duration: 23s; --opacity: 0.7; --size: 1.2px; }
      .star:nth-child(32) { left: 18%; top: 93%; --duration: 25s; --opacity: 0.6; --size: 2.5px; }
      .star:nth-child(33) { left: 35%; top: 25%; --duration: 28s; --opacity: 0.7; --size: 1.8px; }
      .star:nth-child(34) { left: 51%; top: 56%; --duration: 24s; --opacity: 0.6; --size: 2.2px; }
      .star:nth-child(35) { left: 68%; top: 88%; --duration: 26s; --opacity: 0.7; --size: 1.4px; }
      .star:nth-child(36) { left: 84%; top: 15%; --duration: 23s; --opacity: 0.6; --size: 2.7px; }
      .star:nth-child(37) { left: 9%; top: 45%; --duration: 25s; --opacity: 0.7; --size: 1.6px; }
      .star:nth-child(38) { left: 27%; top: 69%; --duration: 28s; --opacity: 0.6; --size: 2.3px; }
      .star:nth-child(39) { left: 48%; top: 11%; --duration: 24s; --opacity: 0.7; --size: 1.3px; }
      .star:nth-child(40) { left: 65%; top: 33%; --duration: 26s; --opacity: 0.6; --size: 2.6px; }
      .star:nth-child(41) { left: 81%; top: 67%; --duration: 23s; --opacity: 0.7; --size: 1.7px; }
      .star:nth-child(42) { left: 94%; top: 84%; --duration: 25s; --opacity: 0.6; --size: 2.4px; }
      .star:nth-child(43) { left: 21%; top: 31%; --duration: 28s; --opacity: 0.7; --size: 1.5px; }
      .star:nth-child(44) { left: 38%; top: 61%; --duration: 24s; --opacity: 0.6; --size: 2.8px; }
      .star:nth-child(45) { left: 55%; top: 86%; --duration: 26s; --opacity: 0.7; --size: 1.2px; }
      .star:nth-child(46) { left: 71%; top: 18%; --duration: 23s; --opacity: 0.6; --size: 2.5px; }
      .star:nth-child(47) { left: 88%; top: 52%; --duration: 25s; --opacity: 0.7; --size: 1.8px; }
      .star:nth-child(48) { left: 6%; top: 78%; --duration: 28s; --opacity: 0.6; --size: 2.2px; }
      .star:nth-child(49) { left: 24%; top: 8%; --duration: 24s; --opacity: 0.7; --size: 1.4px; }
      .star:nth-child(50) { left: 41%; top: 38%; --duration: 26s; --opacity: 0.6; --size: 2.7px; }
      .star:nth-child(51) { left: 58%; top: 65%; --duration: 23s; --opacity: 0.7; --size: 1.6px; }
      .star:nth-child(52) { left: 75%; top: 94%; --duration: 25s; --opacity: 0.6; --size: 2.3px; }
      .star:nth-child(53) { left: 91%; top: 24%; --duration: 28s; --opacity: 0.7; --size: 1.3px; }
      .star:nth-child(54) { left: 17%; top: 54%; --duration: 24s; --opacity: 0.6; --size: 2.6px; }
      .star:nth-child(55) { left: 34%; top: 85%; --duration: 26s; --opacity: 0.7; --size: 1.7px; }
      .star:nth-child(56) { left: 51%; top: 14%; --duration: 23s; --opacity: 0.6; --size: 2.4px; }
      .star:nth-child(57) { left: 67%; top: 44%; --duration: 25s; --opacity: 0.7; --size: 1.5px; }
      .star:nth-child(58) { left: 84%; top: 74%; --duration: 28s; --opacity: 0.6; --size: 2.8px; }
      .star:nth-child(59) { left: 10%; top: 9%; --duration: 24s; --opacity: 0.7; --size: 1.2px; }
      .star:nth-child(60) { left: 27%; top: 39%; --duration: 26s; --opacity: 0.6; --size: 2.5px; }
      .star:nth-child(61) { left: 44%; top: 71%; --duration: 23s; --opacity: 0.7; --size: 1.8px; }
      .star:nth-child(62) { left: 61%; top: 97%; --duration: 25s; --opacity: 0.6; --size: 2.2px; }
      .star:nth-child(63) { left: 77%; top: 27%; --duration: 28s; --opacity: 0.7; --size: 1.4px; }
      .star:nth-child(64) { left: 94%; top: 57%; --duration: 24s; --opacity: 0.6; --size: 2.7px; }
      .star:nth-child(65) { left: 20%; top: 87%; --duration: 26s; --opacity: 0.7; --size: 1.6px; }
      .star:nth-child(66) { left: 37%; top: 16%; --duration: 23s; --opacity: 0.6; --size: 2.3px; }
      .star:nth-child(67) { left: 54%; top: 46%; --duration: 25s; --opacity: 0.7; --size: 1.3px; }
      .star:nth-child(68) { left: 70%; top: 77%; --duration: 28s; --opacity: 0.6; --size: 2.6px; }
      .star:nth-child(69) { left: 87%; top: 7%; --duration: 24s; --opacity: 0.7; --size: 1.7px; }
      .star:nth-child(70) { left: 14%; top: 37%; --duration: 26s; --opacity: 0.6; --size: 2.4px; }
      .star:nth-child(71) { left: 30%; top: 67%; --duration: 23s; --opacity: 0.7; --size: 1.5px; }
      .star:nth-child(72) { left: 47%; top: 97%; --duration: 25s; --opacity: 0.6; --size: 2.8px; }
      .star:nth-child(73) { left: 64%; top: 29%; --duration: 28s; --opacity: 0.7; --size: 1.2px; }
      .star:nth-child(74) { left: 80%; top: 59%; --duration: 24s; --opacity: 0.6; --size: 2.5px; }
      .star:nth-child(75) { left: 97%; top: 87%; --duration: 26s; --opacity: 0.7; --size: 1.8px; }

      .container {
          max-width: 800px;
          width: 90%;
          background: rgba(3, 7, 18, 0.95);
          border: 1px solid rgba(0, 180, 216, 0.15);
          border-radius: 20px;
          padding: 30px;
          box-shadow:
                  0 20px 40px rgba(0, 0, 0, 0.4),
                  0 0 20px rgba(0, 180, 216, 0.03);
          backdrop-filter: blur(10px);
          margin: 60px auto;
          transform-style: preserve-3d;
          perspective: 1000px;
          z-index: 1;
      }

      .container::before {
          content: '';
          position: absolute;
          top: -1px;
          left: -1px;
          right: -1px;
          bottom: -1px;
          background: linear-gradient(45deg,
          rgba(0, 180, 216, 0.08),
          rgba(0, 119, 182, 0.08),
          rgba(0, 180, 216, 0.08));
          border-radius: 20px;
          z-index: -1;
          animation: borderGlow 3s linear infinite;
      }

      .container::after {
          content: '';
          position: absolute;
          top: -20px;
          left: -20px;
          right: -20px;
          bottom: -20px;
          background: radial-gradient(circle at 50% 50%,
          rgba(0, 180, 216, 0.1) 0%,
          transparent 70%);
          z-index: -2;
          animation: containerGlow 10s ease-in-out infinite;
          border-radius: 30px;
          filter: blur(10px);
      }

      @keyframes containerGlow {
          0%, 100% {
              opacity: 0.3;
              transform: scale(1);
          }
          50% {
              opacity: 0.5;
              transform: scale(1.02);
          }
      }

      @keyframes borderGlow {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
      }

      h1 {
          text-align: center;
          color: #fff;
          margin-bottom: 30px;
          font-size: 2.5em;
          font-weight: 600;
          letter-spacing: 1px;
      }

      .input-section {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin-bottom: 30px;
      }

      .input-group {
          display: flex;
          flex-direction: column;
      }

      label {
          font-weight: 600;
          margin-bottom: 8px;
          color: #ccc;
          font-size: 1.1em;
      }

      input {
          padding: 15px;
          border: 2px solid #666;
          border-radius: 10px;
          font-size: 1.1em;
          transition: all 0.3s ease;
          background: rgba(60, 60, 60, 0.8);
          color: #fff;
          font-family: 'Orbitron', sans-serif;
      }

      input:focus {
          outline: none;
          border-color: #888;
          box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
          transform: translateY(-2px);
      }

      input::placeholder {
          color: rgba(255, 255, 255, 0.5);
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .stat-card {
          background: linear-gradient(135deg, rgba(80, 80, 80, 0.8), rgba(60, 60, 60, 0.8));
          color: #fff;
          padding: 20px;
          border: 1px solid #777;
          border-radius: 15px;
          text-align: center;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
          transform: translateY(0);
          transition: transform 0.3s ease;
      }

      .stat-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
      }

      .stat-value {
          font-size: 2em;
          font-weight: bold;
          margin-bottom: 5px;
          font-family: 'Orbitron', sans-serif;
      }

      .stat-label {
          font-size: 0.9em;
          opacity: 0.8;
          font-weight: 500;
      }

      .progress-section {
          margin-bottom: 30px;
      }

      .progress-title {
          font-size: 1.3em;
          font-weight: 600;
          margin-bottom: 15px;
          color: #ddd;
      }

      .progress-bar-container {
          background: rgba(50, 50, 50, 0.8);
          border: 1px solid #666;
          border-radius: 25px;
          height: 30px;
          overflow: hidden;
          position: relative;
          margin-bottom: 10px;
      }

      .progress-bar {
          height: 100%;
          background: linear-gradient(90deg, #4CAF50, #66BB6A);
          border-radius: 25px;
          transition: width 0.8s ease;
          position: relative;
      }

      .progress-text {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-weight: bold;
          color: #fff;
          z-index: 2;
          font-family: 'Orbitron', sans-serif;
          text-shadow: 0 0 3px #000;
      }

      .weekly-progress {
          background: rgba(45, 45, 45, 0.8);
          border: 1px solid #666;
          border-radius: 15px;
          padding: 20px;
          margin-top: 20px;
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .weekly-title {
          font-size: 1.2em;
          font-weight: 600;
          margin-bottom: 15px;
          color: #ddd;
      }

      .weekly-bar-container {
          background: rgba(50, 50, 50, 0.8);
          border: 1px solid #666;
          border-radius: 20px;
          height: 25px;
          overflow: hidden;
          position: relative;
          margin-bottom: 8px;
      }

      .weekly-bar {
          height: 100%;
          background: linear-gradient(90deg, #FF9800, #FF5722);
          border-radius: 20px;
          transition: width 0.8s ease;
      }

      .weekly-text {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-weight: bold;
          color: #fff;
          font-size: 0.9em;
          z-index: 2;
          font-family: 'Orbitron', sans-serif;
          text-shadow: 0 0 3px #000;
      }

      #weeklyDetails {
          color: #aaa;
          font-family: 'Orbitron', sans-serif;
          font-weight: 400;
      }

      @media (max-width: 600px) {
          .input-section {
              grid-template-columns: 1fr;
          }

          .container {
              padding: 20px;
              width: 95%;
              margin: 50px auto;
          }

          h1 {
              font-size: 1.5em;
              margin-bottom: 15px;
              margin-top: 10px;
          }

          .stats-grid {
              grid-template-columns: 1fr;
              gap: 15px;
          }

          .stat-card {
              padding: 15px;
          }

          .progress-section {
              margin-bottom: 20px;
          }

          .weekly-progress {
              padding: 15px;
              margin-top: 15px;
          }

          .signature {
              bottom: 10px;
              right: 10px;
              font-size: 0.5em;
          }
      }

      .signature {
          position: fixed;
          bottom: 20px;
          right: 20px;
          color: rgba(255, 255, 255, 0.4);
          font-family: 'Orbitron', sans-serif;
          font-size: 0.63em;
          letter-spacing: 1px;
          text-shadow: 0 0 10px rgba(0, 180, 216, 0.3);
          z-index: 2;
          animation: signatureGlow 3s ease-in-out infinite alternate;
      }

      .strava-connect {
          position: fixed;
          top: 20px;
          right: 20px;
          background: #FC4C02;
          color: white;
          padding: 10px 20px;
          border-radius: 20px;
          text-decoration: none;
          font-family: 'Orbitron', sans-serif;
          font-size: 0.9em;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(252, 76, 2, 0.3);
          z-index: 2;
          cursor: pointer;
      }

      .strava-connect img {
          width: 20px;
          height: 20px;
      }

      .strava-connected {
          background: #2E7D32;
          box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
      }

      .strava-connected:hover {
          box-shadow: 0 6px 16px rgba(46, 125, 50, 0.4);
      }

      .strava-loading {
          background: #666;
          pointer-events: none;
      }

      .strava-loading::after {
          content: '';
          display: inline-block;
          width: 12px;
          height: 12px;
          margin-left: 8px;
          border: 2px solid #fff;
          border-radius: 50%;
          border-top-color: transparent;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          to { transform: rotate(360deg); }
      }

      @keyframes signatureGlow {
          0% {
              opacity: 0.4;
              text-shadow: 0 0 10px rgba(0, 180, 216, 0.3);
          }
          100% {
              opacity: 0.6;
              text-shadow: 0 0 15px rgba(0, 180, 216, 0.5);
          }
      }

      .sync-status {
          position: fixed;
          top: 70px;
          right: 20px;
          background: rgba(60, 60, 60, 0.9);
          color: #aaa;
          padding: 5px 15px;
          border-radius: 15px;
          font-family: 'Orbitron', sans-serif;
          font-size: 0.75em;
          z-index: 2;
          display: none;
          backdrop-filter: blur(5px);
      }

      .edit-data-button {
          position: fixed;
          bottom: 80px;
          right: 20px;
          background: rgba(0, 180, 216, 0.9);
          color: white;
          padding: 12px 24px;
          border-radius: 20px;
          font-family: 'Orbitron', sans-serif;
          font-size: 0.9em;
          z-index: 2;
          cursor: pointer;
          border: none;
          box-shadow: 0 4px 12px rgba(0, 180, 216, 0.3);
          transition: all 0.3s ease;
      }

      .edit-data-button:hover {
          box-shadow: 0 6px 16px rgba(0, 180, 216, 0.5);
          transform: translateY(-2px);
      }

      .modal-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 1000;
          backdrop-filter: blur(5px);
      }

      .modal-overlay.active {
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .modal-content {
          background: rgba(3, 7, 18, 0.98);
          border: 1px solid rgba(0, 180, 216, 0.3);
          border-radius: 20px;
          padding: 30px;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }

      .modal-title {
          font-size: 1.5em;
          color: #fff;
      }

      .modal-close {
          background: none;
          border: none;
          color: #fff;
          font-size: 1.5em;
          cursor: pointer;
          padding: 0;
          width: 30px;
          height: 30px;
      }

      .week-editor {
          display: grid;
          grid-template-columns: auto 1fr auto;
          gap: 10px;
          align-items: center;
          margin-bottom: 10px;
          padding: 10px;
          background: rgba(60, 60, 60, 0.3);
          border-radius: 10px;
      }

      .week-label {
          color: #ccc;
          font-size: 0.9em;
          min-width: 60px;
      }

      .week-input {
          padding: 8px 12px;
          background: rgba(80, 80, 80, 0.8);
          border: 1px solid #666;
          border-radius: 8px;
          color: #fff;
          font-family: 'Orbitron', sans-serif;
          font-size: 0.9em;
      }

      .week-input:focus {
          outline: none;
          border-color: rgba(0, 180, 216, 0.8);
      }

      .week-date-range {
          color: #888;
          font-size: 0.75em;
      }

      .motivation-message {
          background: linear-gradient(135deg, rgba(0, 180, 216, 0.2), rgba(0, 119, 182, 0.2));
          border: 1px solid rgba(0, 180, 216, 0.3);
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 30px;
          text-align: center;
          font-size: 1.2em;
          color: #fff;
          animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .milestone-marker {
          position: absolute;
          top: -8px;
          width: 4px;
          height: 46px;
          background: rgba(255, 255, 255, 0.5);
          transform: translateX(-2px);
          z-index: 1;
      }

      .milestone-label {
          position: absolute;
          top: -25px;
          transform: translateX(-50%);
          font-size: 0.7em;
          color: rgba(255, 255, 255, 0.7);
          white-space: nowrap;
      }
  </style>
</head>
<body>
<div class="stars">
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
</div>
<button id="stravaConnect" class="strava-connect" aria-label="Connect with Strava to sync running data" role="button">
  <img src="https://images.icon-icons.com/2429/PNG/512/strava_logo_icon_147232.png" alt="Strava logo" aria-hidden="true">
  Connect with Strava
</button>
<div id="syncStatus" class="sync-status" role="status" aria-live="polite"></div>
<button id="editDataButton" class="edit-data-button" aria-label="Edit weekly running data manually">üìù Edit Weekly Data</button>
<div id="editModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Edit Weekly Distances</h2>
      <button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button>
    </div>
    <div id="weekEditorContainer" role="form" aria-label="Weekly distance editor"></div>
    <div style="margin-top: 20px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
      <button onclick="saveManualData()" aria-label="Save weekly distance changes" style="padding: 12px 30px; background: rgba(0, 180, 216, 0.9); color: white; border: none; border-radius: 10px; cursor: pointer; font-family: 'Orbitron', sans-serif;">Save Changes</button>
      <button onclick="exportData()" aria-label="Export data to JSON file" style="padding: 12px 30px; background: rgba(76, 175, 80, 0.9); color: white; border: none; border-radius: 10px; cursor: pointer; font-family: 'Orbitron', sans-serif;">üì• Export</button>
      <label for="importFile" aria-label="Import data from JSON file" style="padding: 12px 30px; background: rgba(255, 152, 0, 0.9); color: white; border: none; border-radius: 10px; cursor: pointer; font-family: 'Orbitron', sans-serif; display: inline-block;">üì§ Import</label>
      <input type="file" id="importFile" accept=".json" onchange="importData(event)" aria-label="Select JSON file to import" style="display: none;">
    </div>
  </div>
</div>
<div class="container">
  <h1>üèÉ‚Äç‚ôÇÔ∏è Running Progress Tracker</h1>

  <div class="input-section" role="form" aria-label="Running goal inputs">
    <div class="input-group">
      <label for="totalKm" id="totalKmLabel">Total KM Goal for 2025:</label>
      <input type="number" id="totalKm" placeholder="e.g., 2000" min="0" step="0.1" value="2000"
             aria-label="Total kilometer goal for the year" aria-describedby="totalKmLabel">
    </div>
    <div class="input-group">
      <label for="currentKm">KM Completed So Far:</label>
      <input type="number" id="currentKm" placeholder="e.g., 850" min="0" step="0.1"
             aria-label="Kilometers completed so far">
    </div>
  </div>

  <div class="stats-grid" role="region" aria-label="Running statistics">
    <div class="stat-card" role="status" aria-label="Weekly kilometers needed">
      <div class="stat-value" id="weeklyNeeded" aria-live="polite">0</div>
      <div class="stat-label">KM/Week Needed</div>
    </div>
    <div class="stat-card" role="status" aria-label="Weeks remaining in year">
      <div class="stat-value" id="weeksLeft" aria-live="polite">0</div>
      <div class="stat-label">Weeks Remaining</div>
    </div>
    <div class="stat-card" role="status" aria-label="Progress status">
      <div class="stat-value" id="kmBehindAhead" aria-live="polite">0</div>
      <div class="stat-label" id="behindAheadLabel">Status</div>
    </div>
    <div class="stat-card" role="status" aria-label="Days into current week">
      <div class="stat-value" id="daysInWeek" aria-live="polite">-</div>
      <div class="stat-label">Days in Current Week</div>
    </div>
    <div class="stat-card" role="status" aria-label="Weekly consistency score">
      <div class="stat-value" id="consistency" aria-live="polite">0%</div>
      <div class="stat-label">Consistency Score</div>
    </div>
    <div class="stat-card" role="status" aria-label="Current weekly streak">
      <div class="stat-value" id="currentStreak" aria-live="polite">0</div>
      <div class="stat-label">Week Streak</div>
    </div>
  </div>

  <div id="motivationMessage" class="motivation-message" style="display: none;" role="status" aria-live="polite"></div>

  <div class="progress-section" role="region" aria-label="Overall progress towards goal">
    <div class="progress-title" id="overallProgressTitle">Overall Progress</div>
    <div class="progress-bar-container" role="progressbar"
         aria-labelledby="overallProgressTitle"
         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
         aria-describedby="overallProgressText">
      <div class="progress-bar" id="overallProgress"></div>
      <div class="progress-text" id="overallProgressText">0%</div>
      <div class="milestone-marker" style="left: 25%;" aria-hidden="true"><div class="milestone-label">25%</div></div>
      <div class="milestone-marker" style="left: 50%;" aria-hidden="true"><div class="milestone-label">50%</div></div>
      <div class="milestone-marker" style="left: 75%;" aria-hidden="true"><div class="milestone-label">75%</div></div>
    </div>
  </div>

  <div class="weekly-progress" role="region" aria-label="Weekly distance breakdown">
    <div class="weekly-title">Weekly Distance</div>
    <div style="height: 300px; margin-top: 20px;">
      <canvas id="weeklyDistanceChart" role="img" aria-label="Bar chart showing individual weekly distances with dynamic targets"></canvas>
    </div>
    <div style="margin-top: 10px; color: #666; font-size: 0.9em;" id="weeklyDistanceDetails" role="status"></div>
  </div>

  <div class="weekly-progress" role="region" aria-label="Weekly progress tracking">
    <div class="weekly-title" id="weeklyProgressTitle">Weekly Progress vs Original Plan</div>
    <div class="weekly-bar-container" role="progressbar"
         aria-labelledby="weeklyProgressTitle"
         aria-valuenow="0" aria-valuemin="0" aria-valuemax="150"
         aria-describedby="weeklyProgressText">
      <div class="weekly-bar" id="weeklyProgress"></div>
      <div class="weekly-text" id="weeklyProgressText">0%</div>
    </div>
    <div style="margin-top: 10px; color: #666; font-size: 0.9em;" id="weeklyDetails" role="status"></div>
    <div style="height: 300px; margin-top: 20px;">
      <canvas id="weeklyChart" role="img" aria-label="Chart showing cumulative weekly progress versus original plan"></canvas>
    </div>
  </div>

  <div class="weekly-progress" role="region" aria-label="Weekly distance gap analysis">
    <div class="weekly-title">Weekly Distance Gap</div>
    <div style="height: 300px; margin-top: 20px;">
      <canvas id="gapChart" role="img" aria-label="Bar chart showing how far ahead or behind schedule you are each week"></canvas>
    </div>
    <div style="margin-top: 10px; color: #666; font-size: 0.9em;" id="gapDetails" role="status"></div>
  </div>
</div>
<div class="signature">chipset508 vibe coding 6/2025</div>

<script>
	let weeklyChart = null;
	let gapChart = null;
	let weeklyDistanceChart = null;

	// Helper function to get the first Monday on or after a date (or the date itself if it's Monday)
	function getNextMonday(date) {
		const d = new Date(date);
		const day = d.getDay();
		// If Sunday (0), add 1 day; if Monday (1), add 0; if Tuesday (2), add 6 days, etc.
		const daysUntilMonday = day === 0 ? 1 : day === 1 ? 0 : 8 - day;
		d.setDate(d.getDate() + daysUntilMonday);
		return d;
	}

	// Helper function to get week number within the year (0-indexed)
	// Week 0 starts on Jan 1 and ends on the first Sunday
	// Week 1 starts on the first Monday and ends on the next Sunday, etc.
	function getWeekNumber(date, yearStart) {
		// Find the first Monday of the year (on or after Jan 1)
		const firstMonday = getNextMonday(yearStart);

		// If date is before the first Monday, it's in Week 0 (partial week)
		if (date < firstMonday) {
			return 0;
		}

		// Calculate weeks from first Monday
		const diffTime = date - firstMonday;
		const diffWeeks = Math.floor(diffTime / (7 * 24 * 60 * 60 * 1000));
		return diffWeeks + 1; // +1 because Week 0 is before the first Monday
	}

	function calculateProgress() {
		const totalKm = Math.max(0, parseFloat(document.getElementById('totalKm').value) || 0);
		const currentKm = Math.max(0, parseFloat(document.getElementById('currentKm').value) || 0);

		if (totalKm === 0) {
			resetDisplay();
			return;
		}

		// Get current date and calculate weeks
		const now = new Date();
		const startOfYear = new Date(now.getFullYear(), 0, 1);
		const endOfYear = new Date(now.getFullYear(), 11, 31);

		// Calculate weeks passed and remaining (using Monday-Sunday week definition)
		const weeksPassed = getWeekNumber(now, startOfYear);
		const lastWeekOfYear = getWeekNumber(endOfYear, startOfYear);
		const totalWeeksInYear = lastWeekOfYear + 1; // +1 because week numbers are 0-indexed
		const weeksRemaining = Math.max(0, totalWeeksInYear - weeksPassed); // Includes current week

		// Calculate original weekly target (total km / total weeks)
		const originalWeeklyTarget = totalWeeksInYear > 0 ? Math.max(0, totalKm / totalWeeksInYear) : 0;

		// Calculate what should have been completed by now
		const shouldHaveCompleted = Math.max(0, originalWeeklyTarget * weeksPassed);

		// Calculate weekly km needed for remaining weeks
		const remainingKm = Math.max(0, totalKm - currentKm);
		const weeklyNeeded = weeksRemaining > 0 ? remainingKm / weeksRemaining : 0;

		// Calculate progress percentages
		const overallProgress = (currentKm / totalKm) * 100;
		const weeklyProgress = weeksPassed > 0 ? (currentKm / shouldHaveCompleted) * 100 : 0;

		// Calculate if behind or ahead
		const difference = currentKm - shouldHaveCompleted;

		// Update display
		document.getElementById('weeklyNeeded').textContent = Math.max(0, weeklyNeeded).toFixed(1);
		document.getElementById('weeksLeft').textContent = Math.max(0, weeksRemaining);

		if (difference >= 0) {
			document.getElementById('kmBehindAhead').textContent = `+${difference.toFixed(1)}`;
			document.getElementById('behindAheadLabel').textContent = 'KM Ahead';
			document.getElementById('kmBehindAhead').parentElement.style.background = 'linear-gradient(135deg, #4CAF50, #8BC34A)';
		} else {
			document.getElementById('kmBehindAhead').textContent = difference.toFixed(1);
			document.getElementById('behindAheadLabel').textContent = 'KM Behind';
			document.getElementById('kmBehindAhead').parentElement.style.background = 'linear-gradient(135deg, #FF5722, #FF9800)';
		}

		// Update progress bars
		const clampedOverallProgress = Math.min(100, Math.max(0, overallProgress));
		const clampedWeeklyProgress = Math.min(150, Math.max(0, weeklyProgress));

		document.getElementById('overallProgress').style.width = clampedOverallProgress + '%';
		document.getElementById('overallProgressText').textContent = Math.max(0, overallProgress).toFixed(1) + '%';
		// Update ARIA attributes for accessibility
		document.querySelector('.progress-bar-container').setAttribute('aria-valuenow', Math.max(0, overallProgress).toFixed(1));

		document.getElementById('weeklyProgress').style.width = (clampedWeeklyProgress / 150) * 100 + '%';
		document.getElementById('weeklyProgressText').textContent = Math.max(0, weeklyProgress).toFixed(1) + '%';
		// Update ARIA attributes for accessibility
		document.querySelectorAll('.weekly-bar-container')[0].setAttribute('aria-valuenow', Math.max(0, weeklyProgress).toFixed(1));

		// Update weekly details
		const currentWeek = Math.max(1, weeksPassed + 1);
		const weeklyDetails = `Original plan: ${Math.max(0, originalWeeklyTarget).toFixed(1)} km/week ‚Ä¢ Week ${currentWeek} of ${Math.max(1, totalWeeksInYear)}`;
		document.getElementById('weeklyDetails').textContent = weeklyDetails;

		// Update progress bar colors based on performance
		const overallBar = document.getElementById('overallProgress');
		const weeklyBar = document.getElementById('weeklyProgress');

		if (overallProgress >= 100) {
			overallBar.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
		} else if (overallProgress >= 80) {
			overallBar.style.background = 'linear-gradient(90deg, #8BC34A, #CDDC39)';
		} else if (overallProgress >= 60) {
			overallBar.style.background = 'linear-gradient(90deg, #CDDC39, #FFC107)';
		} else {
			overallBar.style.background = 'linear-gradient(90deg, #FF9800, #FF5722)';
		}

		if (weeklyProgress >= 100) {
			weeklyBar.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
		} else if (weeklyProgress >= 90) {
			weeklyBar.style.background = 'linear-gradient(90deg, #8BC34A, #CDDC39)';
		} else if (weeklyProgress >= 75) {
			weeklyBar.style.background = 'linear-gradient(90deg, #CDDC39, #FFC107)';
		} else {
			weeklyBar.style.background = 'linear-gradient(90deg, #FF9800, #FF5722)';
		}

		// Calculate enhanced metrics
		calculateEnhancedMetrics(now, weeksPassed, originalWeeklyTarget);

		// Update motivational message
		updateMotivationalMessage(overallProgress, weeklyProgress, difference);

		// Update the weekly chart
		updateWeeklyChart(weeksPassed, totalWeeksInYear, originalWeeklyTarget, currentKm);
		// Update the gap chart
		updateGapChart(weeksPassed, totalWeeksInYear, originalWeeklyTarget);
		// Update the weekly distance chart
		updateWeeklyDistanceChart(weeksPassed, totalWeeksInYear, originalWeeklyTarget, currentKm);
	}

	function updateMotivationalMessage(overallProgress, weeklyProgress, difference) {
		const messageDiv = document.getElementById('motivationMessage');
		let message = '';
		let emoji = '';

		// Goal completed!
		if (overallProgress >= 100) {
			emoji = 'üéâ';
			message = 'Congratulations! You\'ve crushed your goal! Time to celebrate your amazing achievement!';
		}
		// Close to goal (90-99%)
		else if (overallProgress >= 90) {
			emoji = 'üî•';
			message = 'Almost there! The finish line is in sight. Keep pushing, you\'re incredible!';
		}
		// Three quarters done (75-89%)
		else if (overallProgress >= 75) {
			emoji = 'üí™';
			message = 'You\'re in the home stretch! Three quarters done - you\'re unstoppable!';
		}
		// Halfway there (50-74%)
		else if (overallProgress >= 50) {
			emoji = '‚≠ê';
			message = 'Halfway champion! Your consistency is paying off. Keep up the amazing work!';
		}
		// Quarter done (25-49%)
		else if (overallProgress >= 25) {
			emoji = 'üöÄ';
			message = 'Great start! You\'re building momentum. Every kilometer counts!';
		}
		// Just starting (0-24%)
		else {
			emoji = 'üíö';
			message = 'Every journey begins with a single step. You\'ve got this!';
		}

		// Special messages based on being ahead/behind
		if (difference > 20) {
			emoji = 'üëë';
			message = 'Wow! You\'re way ahead of schedule! Absolutely crushing it!';
		} else if (difference > 0 && weeklyProgress >= 100) {
			emoji = '‚ö°';
			message += ' You\'re ahead of schedule - keep riding this wave!';
		} else if (difference < -20 && overallProgress < 90) {
			emoji = 'üí™';
			message = 'Behind schedule? No worries! Consistency beats perfection. You can do this!';
		}

		messageDiv.innerHTML = `${emoji} ${message}`;
		messageDiv.style.display = 'block';
	}

	function calculateEnhancedMetrics(now, weeksPassed, weeklyTarget) {
		// Days in current week
		const dayOfWeek = now.getDay();
		const daysIntoWeek = dayOfWeek === 0 ? 7 : dayOfWeek; // Sunday = 7
		document.getElementById('daysInWeek').textContent = daysIntoWeek;

		// Consistency score and streak
		if (window.weeklyProgressData && window.weeklyProgressData.length > 0) {
			let consistency = 0;
			let currentStreak = 0;
			let streakActive = true;

			// Calculate individual week distances and check against target
			for (let i = 0; i <= Math.min(weeksPassed, 51); i++) {
				const weekDistance = i === 0 ? window.weeklyProgressData[i] :
					window.weeklyProgressData[i] - window.weeklyProgressData[i - 1];

				const metTarget = weekDistance >= weeklyTarget;

				if (metTarget) {
					consistency++;
					if (streakActive) {
						currentStreak++;
					}
				} else {
					streakActive = false;
				}
			}

			const totalWeeks = Math.max(1, weeksPassed + 1);
			const consistencyPercent = ((consistency / totalWeeks) * 100).toFixed(0);
			document.getElementById('consistency').textContent = consistencyPercent + '%';
			document.getElementById('currentStreak').textContent = currentStreak;

			// Color code consistency
			const consistencyCard = document.getElementById('consistency').parentElement;
			if (consistencyPercent >= 80) {
				consistencyCard.style.background = 'linear-gradient(135deg, #4CAF50, #8BC34A)';
			} else if (consistencyPercent >= 60) {
				consistencyCard.style.background = 'linear-gradient(135deg, #8BC34A, #CDDC39)';
			} else if (consistencyPercent >= 40) {
				consistencyCard.style.background = 'linear-gradient(135deg, #CDDC39, #FFC107)';
			} else {
				consistencyCard.style.background = 'linear-gradient(135deg, #FF9800, #FF5722)';
			}
		} else {
			document.getElementById('consistency').textContent = '0%';
			document.getElementById('currentStreak').textContent = '0';
		}
	}

	function updateWeeklyChart(weeksPassed, totalWeeks, weeklyTarget, currentKm) {
		const ctx = document.getElementById('weeklyChart');
		if (!ctx) return;

		// Destroy existing chart if it exists
		if (weeklyChart) {
			weeklyChart.destroy();
			weeklyChart = null;
		}

		// Hide chart container if no weekly data
		const chartContainer = ctx.parentElement;
		if (!window.weeklyProgressData || window.weeklyProgressData.length === 0) {
			chartContainer.style.display = 'none';
			return;
		}

		// Show chart container
		chartContainer.style.display = 'block';

		// Prepare data
		const labels = Array.from({length: totalWeeks}, (_, i) => `Week ${i + 1}`);
		const plannedData = Array.from({length: totalWeeks}, (_, i) => weeklyTarget * (i + 1));

		// Use stored weekly progress data
		const actualData = window.weeklyProgressData.map((value, index) =>
			index <= weeksPassed ? value : null
		);

		// Add "today" marker dataset
		const todayMarker = Array(totalWeeks).fill(null);
		todayMarker[weeksPassed] = actualData[weeksPassed];

		// Create new chart
		weeklyChart = new Chart(ctx, {
			type: 'line',
			data: {
				labels: labels,
				datasets: [
					{
						label: 'Original Plan',
						data: plannedData,
						borderColor: 'rgba(0, 180, 216, 0.8)',
						backgroundColor: 'rgba(0, 180, 216, 0.1)',
						borderWidth: 2,
						fill: false,
						tension: 0.4
					},
					{
						label: 'Current Progress',
						data: actualData,
						borderColor: 'rgba(255, 152, 0, 0.8)',
						backgroundColor: 'rgba(255, 152, 0, 0.1)',
						borderWidth: 2,
						fill: false,
						tension: 0.4,
						spanGaps: true
					},
					{
						label: 'Current Week',
						data: todayMarker,
						borderColor: 'rgba(76, 175, 80, 1)',
						backgroundColor: 'rgba(76, 175, 80, 0.3)',
						pointRadius: 8,
						pointHoverRadius: 10,
						borderWidth: 3,
						showLine: false
					}
				]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				plugins: {
					legend: {
						labels: {
							color: '#fff',
							font: {
								family: 'Orbitron'
							}
						}
					},
					tooltip: {
						mode: 'index',
						intersect: false,
						backgroundColor: 'rgba(0, 0, 0, 0.8)',
						titleColor: '#fff',
						bodyColor: '#fff',
						borderColor: 'rgba(255, 255, 255, 0.2)',
						borderWidth: 1,
						callbacks: {
							title: function(context) {
								const weekNum = context[0].dataIndex;
								const currentYear = new Date().getFullYear();
								const dateRange = getWeekDateRange(weekNum, currentYear);
								return `Week ${weekNum + 1}: ${dateRange}`;
							}
						}
					},
					zoom: {
						pan: {
							enabled: true,
							mode: 'x',
						},
						zoom: {
							wheel: {
								enabled: true,
							},
							pinch: {
								enabled: true
							},
							mode: 'x',
							drag: {
								enabled: true,
								backgroundColor: 'rgba(0, 180, 216, 0.1)',
								borderColor: 'rgba(0, 180, 216, 0.3)',
								borderWidth: 1
							}
						},
						limits: {
							x: {min: 'original', max: 'original', minRange: 4}
						}
					}
				},
				scales: {
					x: {
						grid: {
							color: 'rgba(255, 255, 255, 0.1)'
						},
						ticks: {
							color: '#fff',
							font: {
								family: 'Orbitron'
							}
						}
					},
					y: {
						grid: {
							color: 'rgba(255, 255, 255, 0.1)'
						},
						ticks: {
							color: '#fff',
							font: {
								family: 'Orbitron'
							}
						}
					}
				}
			}
		});
	}

	function updateGapChart(weeksPassed, totalWeeks, weeklyTarget) {
		const ctx = document.getElementById('gapChart');
		if (!ctx) return;

		// Destroy existing chart if it exists
		if (gapChart) {
			gapChart.destroy();
			gapChart = null;
		}

		// Hide chart container if no weekly data
		const chartContainer = ctx.parentElement;
		if (!window.weeklyProgressData || window.weeklyProgressData.length === 0) {
			chartContainer.style.display = 'none';
			return;
		}

		// Show chart container
		chartContainer.style.display = 'block';

		// Calculate weekly gaps
		const gaps = [];
		const labels = [];

		for (let week = 0; week <= Math.min(weeksPassed, 51); week++) {
			const expectedDistance = weeklyTarget * (week + 1); // Cumulative expected distance after (week + 1) weeks
			const actualDistance = window.weeklyProgressData[week] || 0;
			const gap = actualDistance - expectedDistance;

			gaps.push(gap);
			labels.push(`W${week + 1}`);
		}

		// Create color array based on gap values
		const colors = gaps.map(gap => {
			if (gap >= 0) {
				return 'rgba(76, 175, 80, 0.8)'; // Green for ahead
			} else {
				return 'rgba(244, 67, 54, 0.8)'; // Red for behind
			}
		});

		// Highlight current week with thicker border
		const borderWidths = gaps.map((_, index) => index === weeksPassed ? 3 : 1);
		const borderColors = gaps.map((gap, index) => {
			if (index === weeksPassed) {
				return 'rgba(255, 255, 255, 1)'; // White border for current week
			}
			return gap >= 0 ? 'rgba(76, 175, 80, 1)' : 'rgba(244, 67, 54, 1)';
		});

		// Create new chart
		gapChart = new Chart(ctx, {
			type: 'bar',
			data: {
				labels: labels,
				datasets: [{
					label: 'Distance Gap (km)',
					data: gaps,
					backgroundColor: colors,
					borderColor: borderColors,
					borderWidth: borderWidths,
					borderRadius: 4
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				plugins: {
					legend: {
						display: false
					},
					tooltip: {
						mode: 'index',
						intersect: false,
						backgroundColor: 'rgba(0, 0, 0, 0.8)',
						titleColor: '#fff',
						bodyColor: '#fff',
						borderColor: 'rgba(255, 255, 255, 0.2)',
						borderWidth: 1,
						callbacks: {
							title: function(context) {
								const weekNum = context[0].dataIndex;
								const currentYear = new Date().getFullYear();
								const dateRange = getWeekDateRange(weekNum, currentYear);
								return `Week ${weekNum + 1}: ${dateRange}`;
							},
							label: function(context) {
								const value = context.parsed.y;
								const status = value >= 0 ? 'ahead' : 'behind';
								return `${Math.abs(value).toFixed(1)} km ${status}`;
							}
						}
					},
					zoom: {
						pan: {
							enabled: true,
							mode: 'x',
						},
						zoom: {
							wheel: {
								enabled: true,
							},
							pinch: {
								enabled: true
							},
							mode: 'x',
							drag: {
								enabled: true,
								backgroundColor: 'rgba(0, 180, 216, 0.1)',
								borderColor: 'rgba(0, 180, 216, 0.3)',
								borderWidth: 1
							}
						},
						limits: {
							x: {min: 'original', max: 'original', minRange: 4}
						}
					}
				},
				scales: {
					x: {
						grid: {
							color: 'rgba(255, 255, 255, 0.1)'
						},
						ticks: {
							color: '#fff',
							font: {
								family: 'Orbitron',
								size: 10
							},
							maxRotation: 45
						}
					},
					y: {
						grid: {
							color: 'rgba(255, 255, 255, 0.1)'
						},
						ticks: {
							color: '#fff',
							font: {
								family: 'Orbitron'
							},
							callback: function(value) {
								return value + ' km';
							}
						}
					}
				}
			}
		});

		// Update gap details
		const currentGap = gaps[gaps.length - 1] || 0;
		const averageGap = gaps.length > 0 ? gaps.reduce((sum, gap) => sum + gap, 0) / gaps.length : 0;
		const aheadWeeks = gaps.filter(gap => gap >= 0).length;
		const behindWeeks = gaps.filter(gap => gap < 0).length;

		const gapDetails = `Current gap: ${currentGap >= 0 ? '+' : ''}${currentGap.toFixed(1)} km ‚Ä¢ Average gap: ${averageGap >= 0 ? '+' : ''}${averageGap.toFixed(1)} km ‚Ä¢ Ahead: ${aheadWeeks} weeks ‚Ä¢ Behind: ${behindWeeks} weeks`;
		document.getElementById('gapDetails').textContent = gapDetails;
	}

	function updateWeeklyDistanceChart(weeksPassed, totalWeeks, weeklyTarget, currentKm) {
		const ctx = document.getElementById('weeklyDistanceChart');
		if (!ctx) return;

		// Destroy existing chart if it exists
		if (weeklyDistanceChart) {
			weeklyDistanceChart.destroy();
			weeklyDistanceChart = null;
		}

		// Hide chart container if no weekly data
		const chartContainer = ctx.parentElement;
		if (!window.weeklyProgressData || window.weeklyProgressData.length === 0) {
			chartContainer.style.display = 'none';
			return;
		}

		// Show chart container
		chartContainer.style.display = 'block';

		// Calculate individual weekly distances
		const weeklyDistances = [];
		const labels = [];
		const targetLine = [];

		// Get the total goal from the input
		const totalGoal = parseFloat(document.getElementById('totalKm').value) || 0;
		const remainingDistance = Math.max(0, totalGoal - currentKm);
		const weeksRemaining = Math.max(0, totalWeeks - weeksPassed);
		const adjustedWeeklyTarget = weeksRemaining > 0 ? remainingDistance / weeksRemaining : 0;

		for (let week = 0; week <= Math.min(weeksPassed, 51); week++) {
			const currentWeekDistance = week === 0 ? window.weeklyProgressData[week] :
				window.weeklyProgressData[week] - window.weeklyProgressData[week - 1];

			weeklyDistances.push(currentWeekDistance || 0);
			labels.push(`W${week + 1}`);

			// Calculate dynamic target for each week based on progress up to that point
			let dynamicTarget;
			if (week === 0) {
				// For week 1, use the original weekly target
				dynamicTarget = weeklyTarget;
			} else {
				// For subsequent weeks, calculate what was needed based on actual progress
				const progressUpToPreviousWeek = window.weeklyProgressData[week - 1] || 0;
				const remainingDistanceAtWeek = Math.max(0, totalGoal - progressUpToPreviousWeek);
				const remainingWeeksAtWeek = totalWeeks - week;
				dynamicTarget = remainingWeeksAtWeek > 0 ? remainingDistanceAtWeek / remainingWeeksAtWeek : 0;
			}

			targetLine.push(dynamicTarget);
		}

		// Create color array based on performance vs adjusted target
		const colors = weeklyDistances.map((distance, index) => {
			const target = targetLine[index];
			if (distance >= target * 1.1) {
				return 'rgba(76, 175, 80, 0.8)'; // Green for exceeding target by 10%+
			} else if (distance >= target) {
				return 'rgba(139, 195, 74, 0.8)'; // Light green for meeting target
			} else if (distance >= target * 0.8) {
				return 'rgba(255, 193, 7, 0.8)'; // Yellow for close to target
			} else {
				return 'rgba(244, 67, 54, 0.8)'; // Red for below 80% of target
			}
		});

		// Highlight current week with thicker border
		const borderWidths = weeklyDistances.map((_, index) => index === weeksPassed ? 3 : 1);
		const borderColors = weeklyDistances.map((distance, index) => {
			if (index === weeksPassed) {
				return 'rgba(255, 255, 255, 1)'; // White border for current week
			}
			return colors[index].replace('0.8', '1');
		});

		// Create new chart
		weeklyDistanceChart = new Chart(ctx, {
			type: 'bar',
			data: {
				labels: labels,
				datasets: [
					{
						label: 'Weekly Distance (km)',
						data: weeklyDistances,
						backgroundColor: colors,
						borderColor: borderColors,
						borderWidth: borderWidths,
						borderRadius: 4
					},
					{
						label: 'Weekly Target',
						data: targetLine,
						type: 'line',
						borderColor: 'rgba(0, 180, 216, 0.8)',
						backgroundColor: 'rgba(0, 180, 216, 0.1)',
						borderWidth: 2,
						fill: false,
						tension: 0,
						pointRadius: 0,
						pointHoverRadius: 4
					}
				]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				plugins: {
					legend: {
						labels: {
							color: '#fff',
							font: {
								family: 'Orbitron'
							}
						}
					},
					tooltip: {
						mode: 'index',
						intersect: false,
						backgroundColor: 'rgba(0, 0, 0, 0.8)',
						titleColor: '#fff',
						bodyColor: '#fff',
						borderColor: 'rgba(255, 255, 255, 0.2)',
						borderWidth: 1,
						callbacks: {
							title: function(context) {
								const weekNum = context[0].dataIndex;
								const currentYear = new Date().getFullYear();
								const dateRange = getWeekDateRange(weekNum, currentYear);
								return `Week ${weekNum + 1}: ${dateRange}`;
							},
							label: function(context) {
								if (context.datasetIndex === 0) {
									const distance = context.parsed.y;
									const target = targetLine[context.dataIndex];
									const percentage = ((distance / target) * 100).toFixed(1);
									return `Distance: ${distance.toFixed(1)} km (${percentage}% of target)`;
								} else {
									const target = context.parsed.y;
									return `Dynamic Target: ${target.toFixed(1)} km`;
								}
							}
						}
					},
					zoom: {
						pan: {
							enabled: true,
							mode: 'x',
						},
						zoom: {
							wheel: {
								enabled: true,
							},
							pinch: {
								enabled: true
							},
							mode: 'x',
							drag: {
								enabled: true,
								backgroundColor: 'rgba(0, 180, 216, 0.1)',
								borderColor: 'rgba(0, 180, 216, 0.3)',
								borderWidth: 1
							}
						},
						limits: {
							x: {min: 'original', max: 'original', minRange: 4}
						}
					}
				},
				scales: {
					x: {
						grid: {
							color: 'rgba(255, 255, 255, 0.1)'
						},
						ticks: {
							color: '#fff',
							font: {
								family: 'Orbitron',
								size: 10
							},
							maxRotation: 45
						}
					},
					y: {
						grid: {
							color: 'rgba(255, 255, 255, 0.1)'
						},
						ticks: {
							color: '#fff',
							font: {
								family: 'Orbitron'
							},
							callback: function(value) {
								return value + ' km';
							}
						}
					}
				}
			}
		});

		// Update weekly distance details
		const totalDistance = weeklyDistances.reduce((sum, distance) => sum + distance, 0);
		const averageDistance = weeklyDistances.length > 0 ? totalDistance / weeklyDistances.length : 0;
		const maxDistance = Math.max(...weeklyDistances);
		const minDistance = Math.min(...weeklyDistances.filter(d => d > 0));

		// Calculate performance against adjusted targets
		const weeksAboveTarget = weeklyDistances.filter((distance, index) => distance >= targetLine[index]).length;
		const weeksBelowTarget = weeklyDistances.filter((distance, index) => distance < targetLine[index]).length;

		const weeklyDistanceDetails = `Total: ${totalDistance.toFixed(1)} km ‚Ä¢ Average: ${averageDistance.toFixed(1)} km/week ‚Ä¢ Max: ${maxDistance.toFixed(1)} km ‚Ä¢ Min: ${minDistance.toFixed(1)} km ‚Ä¢ Above target: ${weeksAboveTarget} weeks ‚Ä¢ Below target: ${weeksBelowTarget} weeks ‚Ä¢ Adjusted weekly target: ${adjustedWeeklyTarget.toFixed(1)} km`;
		document.getElementById('weeklyDistanceDetails').textContent = weeklyDistanceDetails;
	}

	function resetDisplay() {
		document.getElementById('weeklyNeeded').textContent = '0';
		document.getElementById('weeksLeft').textContent = '0';
		document.getElementById('kmBehindAhead').textContent = '0';
		document.getElementById('behindAheadLabel').textContent = 'Status';
		document.getElementById('overallProgress').style.width = '0%';
		document.getElementById('overallProgressText').textContent = '0%';
		document.getElementById('weeklyProgress').style.width = '0%';
		document.getElementById('weeklyProgressText').textContent = '0%';
		document.getElementById('weeklyDetails').textContent = '';
		document.getElementById('gapDetails').textContent = '';
		document.getElementById('kmBehindAhead').parentElement.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';

		// Reset charts
		if (weeklyChart) {
			weeklyChart.destroy();
			weeklyChart = null;
		}
		if (gapChart) {
			gapChart.destroy();
			gapChart = null;
		}
		if (weeklyDistanceChart) {
			weeklyDistanceChart.destroy();
			weeklyDistanceChart = null;
		}
	}

	// Function to update the year dynamically
	function updateYear() {
		const currentYear = new Date().getFullYear();
		document.getElementById('totalKmLabel').textContent = `Total KM Goal for ${currentYear}:`;
	}

	// Function to save input values to localStorage
	function saveToLocalStorage() {
		const totalKm = document.getElementById('totalKm').value;
		const currentKm = document.getElementById('currentKm').value;

		localStorage.setItem('runningTracker_totalKm', totalKm);
		localStorage.setItem('runningTracker_currentKm', currentKm);
	}

	// Function to load input values from localStorage
	function loadFromLocalStorage() {
		const savedTotalKm = localStorage.getItem('runningTracker_totalKm');
		const savedCurrentKm = localStorage.getItem('runningTracker_currentKm');

		if (savedTotalKm !== null) {
			document.getElementById('totalKm').value = savedTotalKm;
		}

		if (savedCurrentKm !== null) {
			document.getElementById('currentKm').value = savedCurrentKm;
		}
	}

	// Function to ensure non-negative input
	function validateInput(inputElement) {
		const value = parseFloat(inputElement.value);
		if (value < 0 || isNaN(value)) {
			inputElement.value = 0;
		}
	}

	// Debounce function to limit how often a function can run
	function debounce(func, wait) {
		let timeout;
		return function executedFunction(...args) {
			const later = () => {
				clearTimeout(timeout);
				func(...args);
			};
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
		};
	}

	// Create debounced version of calculateProgress (300ms delay)
	const debouncedCalculateProgress = debounce(calculateProgress, 300);

	// Add event listeners
	document.getElementById('totalKm').addEventListener('input', function() {
		validateInput(this);
		saveToLocalStorage();
		debouncedCalculateProgress();
	});
	document.getElementById('currentKm').addEventListener('input', function() {
		validateInput(this);
		saveToLocalStorage();
		debouncedCalculateProgress();
	});

	// Initial setup
	loadFromLocalStorage();
	updateYear();
	calculateProgress();

	// Strava Integration
	const STRAVA_CLIENT_ID = '46751';
	const STRAVA_CLIENT_SECRET = '9875334a71c863428d2db37e5eeb6558d4e60692';
	const STRAVA_REDIRECT_URI = window.location.origin + window.location.pathname;

	function initStravaIntegration() {
		const stravaConnect = document.getElementById('stravaConnect');
		const accessToken = localStorage.getItem('strava_access_token');
		const tokenExpiry = localStorage.getItem('strava_token_expiry');

		// Check for authorization code in URL
		const urlParams = new URLSearchParams(window.location.search);
		const code = urlParams.get('code');
		const error = urlParams.get('error');

		if (code) {
			handleStravaCallback(code);
		} else if (error) {
			console.error('Strava auth error:', error);
			alert('Failed to connect with Strava. Please try again.');
			// Clean up URL
			window.history.replaceState({}, document.title, window.location.pathname);
		}

		if (accessToken && tokenExpiry && new Date().getTime() < parseInt(tokenExpiry)) {
			updateStravaButton(true);
			// Check for cached data first
			const cachedData = localStorage.getItem('strava_weekly_progress');
			if (cachedData) {
				window.weeklyProgressData = JSON.parse(cachedData);
				const totalDistance = window.weeklyProgressData[window.weeklyProgressData.length - 1] || 0;
				document.getElementById('currentKm').value = totalDistance.toFixed(1);
				calculateProgress();
			} else {
				fetchStravaData(accessToken);
			}
		}

		stravaConnect.addEventListener('click', function(e) {
			e.preventDefault();
			if (accessToken && new Date().getTime() < parseInt(tokenExpiry)) {
				// Clear cache and fetch fresh data when manually clicking connect
				clearStravaCache();
				fetchStravaData(accessToken);
			} else {
				try {
					const scope = 'read,activity:read';
					const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(STRAVA_REDIRECT_URI)}&approval_prompt=force&scope=${scope}`;
					console.log('Redirecting to:', authUrl);
					window.location.href = authUrl;
				} catch (error) {
					console.error('Error initiating Strava auth:', error);
					alert('Error connecting to Strava. Please try again.');
				}
			}
		});
	}

	// Show user-friendly error messages
	function showError(message, details = '') {
		const errorDiv = document.createElement('div');
		errorDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; background: rgba(244, 67, 54, 0.95); color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; max-width: 400px; font-family: Orbitron, sans-serif; font-size: 0.9em;';
		errorDiv.innerHTML = `<strong>Error:</strong> ${message}${details ? '<br><small>' + details + '</small>' : ''}`;
		document.body.appendChild(errorDiv);
		setTimeout(() => errorDiv.remove(), 5000);
	}

	// Retry function for failed API calls
	async function retryFetch(fetchFn, retries = 3, delay = 1000) {
		for (let i = 0; i < retries; i++) {
			try {
				return await fetchFn();
			} catch (error) {
				if (i === retries - 1) throw error;
				await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
			}
		}
	}

	// Update sync status display
	function updateSyncStatus() {
		const syncStatus = document.getElementById('syncStatus');
		const timestamp = localStorage.getItem('strava_weekly_progress_timestamp');

		if (timestamp) {
			const lastSync = new Date(parseInt(timestamp));
			const now = new Date();
			const diffMinutes = Math.floor((now - lastSync) / (1000 * 60));

			let timeAgo;
			if (diffMinutes < 1) {
				timeAgo = 'just now';
			} else if (diffMinutes < 60) {
				timeAgo = `${diffMinutes}m ago`;
			} else if (diffMinutes < 1440) {
				const hours = Math.floor(diffMinutes / 60);
				timeAgo = `${hours}h ago`;
			} else {
				const days = Math.floor(diffMinutes / 1440);
				timeAgo = `${days}d ago`;
			}

			syncStatus.textContent = `Last synced: ${timeAgo}`;
			syncStatus.style.display = 'block';
		} else {
			syncStatus.style.display = 'none';
		}
	}

	function updateStravaButton(connected, loading = false) {
		const stravaConnect = document.getElementById('stravaConnect');
		stravaConnect.className = 'strava-connect';

		if (loading) {
			stravaConnect.classList.add('strava-loading');
			stravaConnect.innerHTML = '<img src="https://images.icon-icons.com/2429/PNG/512/strava_logo_icon_147232.png" alt="Strava"> Loading...';
		} else if (connected) {
			stravaConnect.classList.add('strava-connected');
			stravaConnect.innerHTML = '<img src="https://images.icon-icons.com/2429/PNG/512/strava_logo_icon_147232.png" alt="Strava"> üîÑ Refresh Data';
		} else {
			stravaConnect.innerHTML = '<img src="https://images.icon-icons.com/2429/PNG/512/strava_logo_icon_147232.png" alt="Strava"> Connect with Strava';
		}

		// Update sync status when button state changes
		if (connected) {
			updateSyncStatus();
			// Update sync status every minute
			setInterval(updateSyncStatus, 60000);
		}
	}

	async function handleStravaCallback(code) {
		updateStravaButton(false, true);

		try {
			const response = await fetch('https://www.strava.com/oauth/token', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					client_id: STRAVA_CLIENT_ID,
					client_secret: STRAVA_CLIENT_SECRET,
					code: code,
					grant_type: 'authorization_code'
				})
			});

			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(`Failed to get access token: ${errorData.message || response.statusText}`);
			}

			const data = await response.json();

			// Store tokens
			localStorage.setItem('strava_access_token', data.access_token);
			localStorage.setItem('strava_refresh_token', data.refresh_token);
			localStorage.setItem('strava_token_expiry', (new Date().getTime() + data.expires_in * 1000).toString());

			// Clean up URL
			window.history.replaceState({}, document.title, window.location.pathname);

			// Fetch user data
			await fetchStravaData(data.access_token);
		} catch (error) {
			console.error('Error during Strava authentication:', error);
			showError('Failed to connect with Strava', error.message);
			updateStravaButton(false);
			// Clear any stored tokens on auth failure
			localStorage.removeItem('strava_access_token');
			localStorage.removeItem('strava_refresh_token');
			localStorage.removeItem('strava_token_expiry');
		}
	}

	async function fetchStravaData(accessToken) {
		updateStravaButton(true, true);

		try {
			// Check if we have cached data that's less than 24 hours old
			const cachedData = localStorage.getItem('strava_weekly_progress');
			const cacheTimestamp = localStorage.getItem('strava_weekly_progress_timestamp');
			const now = new Date().getTime();

			if (cachedData && cacheTimestamp && (now - parseInt(cacheTimestamp)) < 24 * 60 * 60 * 1000) {
				// Use cached data if it's less than 24 hours old
				const weeklyProgress = JSON.parse(cachedData);
				window.weeklyProgressData = weeklyProgress;
				const totalDistance = weeklyProgress[weeklyProgress.length - 1] || 0;
				document.getElementById('currentKm').value = totalDistance.toFixed(1);
				calculateProgress();
				updateStravaButton(true);
				return;
			}

			const currentYear = new Date().getFullYear();
			const startOfYear = new Date(currentYear, 0, 1).getTime() / 1000;
			const endOfYear = new Date(currentYear, 11, 31).getTime() / 1000;

			const response = await retryFetch(async () => {
				const res = await fetch(`https://www.strava.com/api/v3/athlete/activities?after=${startOfYear}&before=${endOfYear}&per_page=200`, {
					headers: {
						'Authorization': `Bearer ${accessToken}`
					}
				});

				if (!response.ok) {
					if (res.status === 401) {
						throw new Error('Strava authentication expired. Please reconnect.');
					} else if (res.status === 429) {
						throw new Error('Strava rate limit exceeded. Please try again later.');
					}
					throw new Error(`Strava API error: ${res.status} ${res.statusText}`);
				}
				return res;
			});

			const activities = await response.json();
			const runningActivities = activities.filter(activity => activity.type === 'Run');

			// Calculate weekly progress
			const yearStart = new Date(currentYear, 0, 1);
			const weeklyProgress = new Array(52).fill(0);
			runningActivities.forEach(activity => {
				const activityDate = new Date(activity.start_date);
				const weekNumber = getWeekNumber(activityDate, yearStart);
				if (weekNumber >= 0 && weekNumber < 52) {
					weeklyProgress[weekNumber] += activity.distance / 1000; // Convert to km
				}
			});

			// Calculate cumulative progress
			let cumulativeProgress = 0;
			const cumulativeWeeklyProgress = weeklyProgress.map(weekDistance => {
				cumulativeProgress += weekDistance;
				return cumulativeProgress;
			});

			// Store the data in localStorage with timestamp
			localStorage.setItem('strava_weekly_progress', JSON.stringify(cumulativeWeeklyProgress));
			localStorage.setItem('strava_weekly_progress_timestamp', now.toString());

			// Update the current KM input with total distance
			const totalDistance = runningActivities.reduce((sum, activity) => sum + activity.distance / 1000, 0);
			document.getElementById('currentKm').value = totalDistance.toFixed(1);

			// Store weekly progress for the chart
			window.weeklyProgressData = cumulativeWeeklyProgress;

			calculateProgress();
			updateStravaButton(true);
			updateSyncStatus();
		} catch (error) {
			console.error('Error fetching Strava data:', error);
			showError('Failed to fetch Strava data', error.message);
			updateStravaButton(true);

			// If token expired, clear stored tokens
			if (error.message.includes('expired') || error.message.includes('401')) {
				localStorage.removeItem('strava_access_token');
				localStorage.removeItem('strava_refresh_token');
				localStorage.removeItem('strava_token_expiry');
				updateStravaButton(false);
			}
		}
	}

	// Add function to clear cached data
	function clearStravaCache() {
		localStorage.removeItem('strava_weekly_progress');
		localStorage.removeItem('strava_weekly_progress_timestamp');
	}

	// Get date range for a week number
	function getWeekDateRange(weekNumber, year) {
		const yearStart = new Date(year, 0, 1);
		const firstMonday = getNextMonday(yearStart);

		let weekStart;
		if (weekNumber === 0) {
			weekStart = yearStart;
		} else {
			weekStart = new Date(firstMonday);
			weekStart.setDate(firstMonday.getDate() + (weekNumber - 1) * 7);
		}

		const weekEnd = new Date(weekStart);
		if (weekNumber === 0) {
			weekEnd.setDate(firstMonday.getDate() - 1);
		} else {
			weekEnd.setDate(weekStart.getDate() + 6);
		}

		const formatDate = (d) => {
			const month = d.toLocaleString('default', { month: 'short' });
			return `${month} ${d.getDate()}`;
		};

		return `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
	}

	// Close modal
	function closeModal() {
		document.getElementById('editModal').classList.remove('active');
	}

	// Keyboard navigation for modal
	document.addEventListener('keydown', function(e) {
		const modal = document.getElementById('editModal');
		if (e.key === 'Escape' && modal.classList.contains('active')) {
			closeModal();
		}
	});

	// Trap focus in modal when open
	document.getElementById('editModal').addEventListener('keydown', function(e) {
		if (e.key === 'Tab') {
			const focusableElements = this.querySelectorAll('button, input, [tabindex]:not([tabindex="-1"])');
			const firstElement = focusableElements[0];
			const lastElement = focusableElements[focusableElements.length - 1];

			if (e.shiftKey && document.activeElement === firstElement) {
				e.preventDefault();
				lastElement.focus();
			} else if (!e.shiftKey && document.activeElement === lastElement) {
				e.preventDefault();
				firstElement.focus();
			}
		}
	});

	// Open manual data editor
	function openDataEditor() {
		const modal = document.getElementById('editModal');
		const container = document.getElementById('weekEditorContainer');
		container.innerHTML = '';

		const currentYear = new Date().getFullYear();
		const now = new Date();
		const yearStart = new Date(currentYear, 0, 1);
		const currentWeek = getWeekNumber(now, yearStart);

		// Get existing data or create empty array
		const weeklyData = window.weeklyProgressData || new Array(52).fill(0);

		// Calculate individual week distances from cumulative data
		const individualWeekDistances = [];
		for (let i = 0; i <= Math.min(currentWeek, 51); i++) {
			const distance = i === 0 ? weeklyData[i] : weeklyData[i] - weeklyData[i - 1];
			individualWeekDistances.push(distance || 0);
		}

		// Create input for each week up to current week
		for (let i = 0; i <= Math.min(currentWeek, 51); i++) {
			const weekDiv = document.createElement('div');
			weekDiv.className = 'week-editor';

			const dateRange = getWeekDateRange(i, currentYear);

			weekDiv.innerHTML = `
				<div class="week-label">Week ${i + 1}</div>
				<input type="number" class="week-input" id="week_${i}" value="${individualWeekDistances[i].toFixed(1)}" min="0" step="0.1">
				<div class="week-date-range">${dateRange}</div>
			`;

			container.appendChild(weekDiv);
		}

		modal.classList.add('active');
	}

	// Export data as JSON
	function exportData() {
		const data = {
			totalKm: document.getElementById('totalKm').value,
			currentKm: document.getElementById('currentKm').value,
			weeklyProgressData: window.weeklyProgressData || [],
			exportDate: new Date().toISOString(),
			year: new Date().getFullYear()
		};

		const dataStr = JSON.stringify(data, null, 2);
		const dataBlob = new Blob([dataStr], { type: 'application/json' });
		const url = URL.createObjectURL(dataBlob);

		const link = document.createElement('a');
		link.href = url;
		link.download = `running-tracker-${data.year}-${new Date().toISOString().split('T')[0]}.json`;
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
		URL.revokeObjectURL(url);
	}

	// Import data from JSON
	function importData(event) {
		const file = event.target.files[0];
		if (!file) return;

		const reader = new FileReader();
		reader.onload = function(e) {
			try {
				const data = JSON.parse(e.target.result);

				// Validate data structure
				if (!data.weeklyProgressData || !Array.isArray(data.weeklyProgressData)) {
					throw new Error('Invalid data format');
				}

				// Import the data
				document.getElementById('totalKm').value = data.totalKm || 2000;
				document.getElementById('currentKm').value = data.currentKm || 0;
				window.weeklyProgressData = data.weeklyProgressData;

				// Store in localStorage
				localStorage.setItem('runningTracker_totalKm', data.totalKm || 2000);
				localStorage.setItem('runningTracker_currentKm', data.currentKm || 0);
				localStorage.setItem('strava_weekly_progress', JSON.stringify(data.weeklyProgressData));
				localStorage.setItem('strava_weekly_progress_timestamp', new Date().getTime().toString());

				// Recalculate and close modal
				calculateProgress();
				document.getElementById('editModal').classList.remove('active');
				updateSyncStatus();

				alert('Data imported successfully!');
			} catch (error) {
				alert('Error importing data: ' + error.message);
			}
		};
		reader.readAsText(file);

		// Reset file input
		event.target.value = '';
	}

	// Save manually entered data
	function saveManualData() {
		const currentYear = new Date().getFullYear();
		const now = new Date();
		const yearStart = new Date(currentYear, 0, 1);
		const currentWeek = getWeekNumber(now, yearStart);

		// Collect individual week distances
		const individualWeekDistances = [];
		for (let i = 0; i <= Math.min(currentWeek, 51); i++) {
			const input = document.getElementById(`week_${i}`);
			individualWeekDistances.push(parseFloat(input.value) || 0);
		}

		// Convert to cumulative
		let cumulative = 0;
		const cumulativeData = new Array(52).fill(0);
		for (let i = 0; i < individualWeekDistances.length; i++) {
			cumulative += individualWeekDistances[i];
			cumulativeData[i] = cumulative;
		}

		// Store the data
		window.weeklyProgressData = cumulativeData;
		localStorage.setItem('strava_weekly_progress', JSON.stringify(cumulativeData));
		localStorage.setItem('strava_weekly_progress_timestamp', new Date().getTime().toString());

		// Update current KM
		document.getElementById('currentKm').value = cumulative.toFixed(1);

		// Recalculate and close modal
		calculateProgress();
		document.getElementById('editModal').classList.remove('active');
		updateSyncStatus();
	}

	// Add edit data button listener
	document.getElementById('editDataButton').addEventListener('click', openDataEditor);

	// Initialize Strava integration
	initStravaIntegration();
</script>
</body>
</html>
